<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Potrero Golf Course — 9‑Hole Scorekeeper</title>
<meta name="theme-color" content="#0f172a">
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--border:#e5e7eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 28px}
h1{margin:0 0 6px 0}
.muted{color:var(--muted)}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.tab{border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer}
.tab.active{background:#0f172a;color:#fff;border-color:#0f172a}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
.card-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.card-c{padding:12px 14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,input,select{height:44px;border-radius:12px;border:1px solid var(--border);padding:0 12px;background:#fff;font-size:16px}
button{background:#0f172a;color:#fff;border-color:#0f172a;cursor:pointer}
button.ghost{background:#fff;color:#111;border-color:#efefef}
button.warn{background:#ef4444;border-color:#ef4444}
label.small{font-size:.8rem;color:var(--muted);display:block;margin-bottom:4px}
.vscore{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;margin-top:12px}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
thead th{position:sticky;top:0;background:#f3f4f6;z-index:1}
.namecell{position:sticky;left:0;background:#fff;border-right:1px solid var(--border);text-align:left}
.cellbtn{width:78px;height:48px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:22px;color:#111}
.tiny-roster{font-size:.85rem;color:#374151;margin:6px 0 10px 0}
.bigfinal{height:50px;font-size:18px;font-weight:800;border-radius:14px;width:100%}
/* keypad */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:end;justify-content:center;z-index:2000}
.sheet{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:520px;padding:14px 14px 20px;box-shadow:0 -10px 30px rgba(0,0,0,.2)}
.sheet-h{display:flex;align-items:center;justify-content:space-between}
.gridnums{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
.gridnums button{height:54px;border-radius:12px;border:1px solid var(--border);background:#f8fafc;font-size:24px;font-weight:bold;color:#000}
.win{background:#d1fae5 !important}.wintext{color:#065f46;font-weight:700}
</style>

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>
<body>
<div class="wrap">
  <h1>Potrero Golf Course — 9‑Hole Scorekeeper</h1>
  <p class="muted">Build: <strong>PWA</strong></p>

  <div class="tabs">
    <div class="tab active" data-tab="score">Scorecard</div>
    <div class="tab" data-tab="leaderboard">Leaderboard</div>
    <div class="tab" data-tab="players">Players</div>
    <div class="tab" data-tab="teams">Teams</div>
    <div class="tab" data-tab="history">Past Rounds</div>
    <div class="tab" data-tab="backup">Backup</div>
  </div>

  <!-- SCORE TAB -->
  <div id="tab-score" class="tabview" style="display:block">
    <div class="card">
      <div class="card-h">
        <div class="row">
          <div>
            <label class="small">Mode</label>
            <select id="scoreMode">
              <option value="individual">Individuals</option>
              <option value="teams">Teams</option>
            </select>
          </div>
          <button id="btnClearRound" class="ghost">New Round / Clear Score</button>
          <button id="btnSave">Save</button>
          <button id="btnCSV" class="ghost">CSV</button>
        </div>
      </div>
      <div class="card-c">
        <h2 style="text-align:center;margin:6px 0 0">Potrero Country Club</h2>
        <div id="topRoster" class="tiny-roster" style="display:none"></div>
        <div class="vscore">
          <table id="vTable">
            <thead id="vHead"></thead>
            <tbody id="vBody"></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btnFinalize" class="bigfinal" onclick="try{finalizeRound()}catch(e){}">Final Score</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD TAB -->
  <div id="tab-leaderboard" class="tabview" style="display:none">
    <div class="card">
      <div class="card-h"><h2>Leaderboard</h2></div>
      <div class="card-c">
        <div id="liveLeaders"></div>
      </div>
    </div>
  </div>

  <!-- PLAYERS TAB -->
  <div id="tab-players" class="tabview" style="display:none">
    <div class="card">
      <div class="card-h"><h2>Players</h2></div>
      <div class="card-c">
        <div class="section"><label class="small">Selected for scorecard</label><div id="playersChips" class="row"></div></div>
        <div class="list" id="playersList"></div>
        <div class="row" style="margin-top:8px">
          <input id="newPlayerName" class="flex" placeholder="Add player name" />
          <button id="addPlayerBtn">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TEAMS TAB -->
  <div id="tab-teams" class="tabview" style="display:none">
    <div class="card">
      <div class="card-h"><h2>Teams</h2></div>
      <div class="card-c">
        <div class="row">
          <div class="flex"><label class="small">Team 1</label><input id="team1Name" placeholder="Team 1" /></div>
          <div class="flex"><label class="small">Team 2</label><input id="team2Name" placeholder="Team 2" /></div>
          <div class="flex"><label class="small">Team 3</label><input id="team3Name" placeholder="Team 3" /></div>
        </div>
        <div id="teamAssignList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div id="tab-history" class="tabview" style="display:none">
    <div class="card">
      <div class="card-h"><h2>Past Rounds</h2></div>
      <div class="card-c"><div id="roundsList" class="list"><div class="muted">No rounds saved yet.</div></div></div>
    </div>
  </div>

  <!-- BACKUP TAB -->
  <div id="tab-backup" class="tabview" style="display:none">
    <div class="card">
      <div class="card-h"><h2>Backup</h2></div>
      <div class="card-c">
        <div class="row">
          <button id="btnExport">Export JSON</button>
          <button id="btnUpdate" class="ghost">Check for Update</button>
          <input id="fileInput" type="file" accept="application/json" style="display:none" />
          <button id="btnImport" class="ghost">Import JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results / Tie Modal -->
<div id="finalModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1100">
  <div style="background:#fff;max-width:640px;width:94%;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden">
    <div style="padding:16px 18px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">Results</div>
      <button id="finalClose" class="ghost">✕</button>
    </div>
    <div id="finalBody" style="padding:18px"></div>
  </div>
</div>

<!-- keypad overlay -->
<div id="overlay" class="overlay">
  <div class="sheet">
    <div class="sheet-h">
      <div class="title">Set strokes</div>
      <button id="closeOverlay" class="ghost">✕</button>
    </div>
    <div class="gridnums" id="keypad"></div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="moreBtn" class="ghost">More…</button>
    </div>
    <div class="row" id="manualRow" style="margin-top:10px; display:none">
      <input id="directInput" type="number" inputmode="none" min="0" max="20" class="flex" placeholder="Type 9–15" />
      <button id="applyDirect">Apply</button>
    </div>
  </div>
</div>

<script>
// ---- tabs ----
function setActiveTab(name){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  const tabBtn=document.querySelector(`.tab[data-tab="${name}"]`);
  if(tabBtn) tabBtn.classList.add('active');
  document.querySelectorAll('.tabview').forEach(v=>v.style.display='none');
  const view=document.getElementById('tab-'+name); if(view) view.style.display='block';
  try{ localStorage.setItem('g9_last_tab', name); }catch(e){}
}
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));
document.addEventListener('DOMContentLoaded', ()=> setActiveTab(localStorage.getItem('g9_last_tab')||'score'));
window.addEventListener('pageshow', ()=> setActiveTab(localStorage.getItem('g9_last_tab')||'score'));

// ---- storage helpers ----
const LS={players:'g9_players_v5', rounds:'g9_rounds_v5', teams:'g9_teams_v4', mode:'g9_mode_v3', draft:'g9_draft_v1', draft_backup:'g9_draft_backup_v1'};
const el=id=>document.getElementById(id);
function load(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}}
function save(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
function download(filename,text,mime="text/plain"){const blob=new Blob([text],{type:mime+";charset=utf-8"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);}
function uid(){return (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2));}

// ---- data ----
let players=load(LS.players,[]);
// ensure preset players exist
(function ensurePresetPlayers(){
  const required = ['Eric','Luz','Osiel','Francisco','Javier','Rafael'];
  const lower = new Set(players.map(p => (p.name||'').toLowerCase()));
  required.forEach(n => {
    if(!lower.has(n.toLowerCase())){
      players.push({id:uid(), name:n});
      lower.add(n.toLowerCase());
    }
  });
  save(LS.players, players);
})();

let rounds=load(LS.rounds,[]);
let teams=load(LS.teams,{t1:{name:'Team 1',members:[]},t2:{name:'Team 2',members:[]},t3:{name:'Team 3',members:[]}});
let mode=load(LS.mode,'individual');
let selectedPlayerIds=[];
let scores={};
let teamScores={t1:Array(9).fill(0),t2:Array(9).fill(0),t3:Array(9).fill(0)};
let keypadTarget=null;
let winnerKeys=[];

// ---- early draft restore ----
(function earlyDraft(){
  try{
    const raw=localStorage.getItem(LS.draft)||localStorage.getItem(LS.draft_backup);
    if(raw){
      const d=JSON.parse(raw);
      if(d){ mode=d.mode||mode; selectedPlayerIds=d.playerIds||selectedPlayerIds; scores=d.scores||scores; teamScores=d.teamScores||teamScores; }
    }
  }catch{}
})();

// if no selected players yet, default first 4
if(selectedPlayerIds.length===0) selectedPlayerIds=players.slice(0,4).map(p=>p.id);
selectedPlayerIds.forEach(pid=>{ if(!Array.isArray(scores[pid])) scores[pid]=Array(9).fill(0); });

// ---- keypad ----
const overlay=el('overlay'), keypad=el('keypad'), moreBtn=el('moreBtn'), manualRow=el('manualRow'), directInput=el('directInput');
el('closeOverlay').onclick=()=>{overlay.style.display='none'; manualRow.style.display='none';};
function buildKeypad(){ keypad.innerHTML=''; for(let n=1;n<=8;n++){ const b=document.createElement('button'); b.textContent=String(n); b.onclick=()=>{ if(!keypadTarget)return; setScore(keypadTarget.type,keypadTarget.key,keypadTarget.idx,n); overlay.style.display='none'; manualRow.style.display='none'; }; keypad.appendChild(b);} }
buildKeypad();
moreBtn.onclick=()=>{ manualRow.style.display='flex'; };
el('applyDirect').onclick=()=>{ const v=Math.max(0,Math.min(20,parseInt(directInput.value||'0',10)||0)); if(keypadTarget){ setScore(keypadTarget.type,keypadTarget.key,keypadTarget.idx,v);} overlay.style.display='none'; manualRow.style.display='none'; };

// ---- renderers ----
const vHead=el('vHead'), vBody=el('vBody'), playersChips=el('playersChips'), playersList=el('playersList');
function renderPlayersChips(){
  playersChips.innerHTML='';
  players.forEach(p=>{
    const label=document.createElement('label'); label.className='tab chip';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=selectedPlayerIds.includes(p.id);
    chk.onchange=()=>{ if(chk.checked){ if(!selectedPlayerIds.includes(p.id)) selectedPlayerIds.push(p.id); if(!scores[p.id]) scores[p.id]=Array(9).fill(0);} else { selectedPlayerIds=selectedPlayerIds.filter(id=>id!==p.id);} renderVCard(); renderLiveLeaderboard(); saveAll(); saveDraft(); };
    const span=document.createElement('span'); span.textContent=p.name;
    label.append(chk,span); playersChips.appendChild(label);
  });
}
function renderRosterLine(){
  const defs=[{id:'t1',...teams.t1},{id:'t2',...teams.t2},{id:'t3',...teams.t3}];
  const parts=defs.filter(t=>t.members&&t.members.length>0).map(t=>{
    const names=t.members.map(pid=>(players.find(x=>x.id===pid)||{name:pid}).name).join(', ');
    return `${t.name}: ${names}`;
  });
  const top=document.getElementById('topRoster');
  if(parts.length>0){ top.textContent=parts.join('  •  '); top.style.display='block'; } else { top.style.display='none'; }
}
function openKeypad(type,key,idx,current){ keypadTarget={type,key,idx}; directInput.value=current||0; manualRow.style.display='none'; overlay.style.display='flex'; }
function makeCell(value,openFn){ const td=document.createElement('td'); const btn=document.createElement('button'); btn.className='cellbtn'; btn.textContent=String(value||0); btn.onclick=openFn; td.appendChild(btn); return td; }
function renderVCard(){
  vHead.innerHTML=''; vBody.innerHTML='';
  const trh=document.createElement('tr');
  const thHole=document.createElement('th'); thHole.textContent='Hole'; thHole.className='namecell'; trh.appendChild(thHole);
  if(mode==='individual'){
    document.getElementById('topRoster').style.display='none';
    selectedPlayerIds.forEach(pid=>{
      const th=document.createElement('th'); th.textContent=(players.find(p=>p.id===pid)||{name:pid}).name; if(winnerKeys.includes(pid)){ th.classList.add('win','wintext'); } trh.appendChild(th);
    });
  }else{
    renderRosterLine();
    [{id:'t1',...teams.t1},{id:'t2',...teams.t2},{id:'t3',...teams.t3}].forEach(t=>{
      if(t.members.length>0){ const th=document.createElement('th'); th.textContent=t.name||t.id.toUpperCase(); if(winnerKeys.includes(t.id)){ th.classList.add('win','wintext'); } trh.appendChild(th); }
    });
  }
  const thTotal=document.createElement('th'); thTotal.textContent='Total'; trh.appendChild(thTotal); vHead.appendChild(trh);

  for(let i=0;i<9;i++){
    const tr=document.createElement('tr');
    const th=document.createElement('th'); th.textContent='H'+(i+1); th.className='namecell'; tr.appendChild(th);
    if(mode==='individual'){
      selectedPlayerIds.forEach(pid=>{ const arr=scores[pid]||Array(9).fill(0); tr.appendChild(makeCell(arr[i]||0,()=>openKeypad('player',pid,i,arr[i]||0))); });
    }else{
      ['t1','t2','t3'].forEach(tid=>{ const t=teams[tid]; if(t.members.length>0){ const arr=teamScores[tid]||Array(9).fill(0); tr.appendChild(makeCell(arr[i]||0,()=>openKeypad('team',tid,i,arr[i]||0))); } });
    }
    const td=document.createElement('td'); td.textContent=''; tr.appendChild(td);
    vBody.appendChild(tr);
  }
  const trt=document.createElement('tr');
  const tht=document.createElement('th'); tht.textContent='Total'; tht.className='namecell'; trt.appendChild(tht);
  if(mode==='individual'){
    selectedPlayerIds.forEach(pid=>{ const arr=scores[pid]||Array(9).fill(0); const gp=Math.max(1,currentPlayedHolesIndividual()); const total=arr.slice(0,gp).reduce((a,b)=>a+(b||0),0); const td=document.createElement('td'); td.textContent=String(total); trt.appendChild(td); });
  }else{
    ['t1','t2','t3'].forEach(tid=>{ const t=teams[tid]; if(t.members.length>0){ const arr=teamScores[tid]||Array(9).fill(0); const gp=Math.max(1,currentPlayedHolesTeams()); const total=arr.slice(0,gp).reduce((a,b)=>a+(b||0),0); const td=document.createElement('td'); td.textContent=String(total); trt.appendChild(td); } });
  }
  const tdBlank=document.createElement('td'); tdBlank.textContent=''; trt.appendChild(tdBlank); vBody.appendChild(trt);
}

// ---- scoring & persistence ----
function saveAll(){ save(LS.players,players); save(LS.rounds,rounds); save(LS.teams,teams); save(LS.mode,mode); }
function saveDraft(){ const d={mode,playerIds:[...selectedPlayerIds],scores,teamScores}; save(LS.draft,d); save(LS.draft_backup,d); }
function setScore(type,key,idx,v){
  if(type==='player'){ if(!scores[key]) scores[key]=Array(9).fill(0); scores[key][idx]=v; }
  else if(type==='team'){ if(!teamScores[key]) teamScores[key]=Array(9).fill(0); teamScores[key][idx]=v; }
  saveDraft(); renderVCard(); renderLiveLeaderboard();
}

// ---- players / teams setup ----
function renderSetupPlayers(){
  const playersList=document.getElementById('playersList'); playersList.innerHTML='';
  players.forEach(p=>{
    const row=document.createElement('div'); row.className='row';
    const name=document.createElement('input'); name.value=p.name; name.oninput=()=>{ p.name=name.value; saveAll(); renderVCard(); renderLiveLeaderboard(); };
    name.style.flex='1';
    const del=document.createElement('button'); del.className='warn'; del.textContent='Delete'; del.onclick=()=>{ players=players.filter(x=>x.id!==p.id); selectedPlayerIds=selectedPlayerIds.filter(id=>id!==p.id); delete scores[p.id]; ['t1','t2','t3'].forEach(tid=> teams[tid].members=teams[tid].members.filter(id=>id!==p.id)); saveAll(); saveDraft(); renderSetupPlayers(); renderPlayersChips(); renderVCard(); };
    row.append(name,del); playersList.appendChild(row);
  });
}
document.getElementById('addPlayerBtn').onclick=()=>{ const name=document.getElementById('newPlayerName').value.trim(); if(!name) return; const p={id:uid(),name}; players.push(p); document.getElementById('newPlayerName').value=''; saveAll(); saveDraft(); renderSetupPlayers(); renderPlayersChips(); renderVCard(); };

function renderTeamsTab(){
  document.getElementById('team1Name').value=teams.t1.name||'Team 1';
  document.getElementById('team2Name').value=teams.t2.name||'Team 2';
  document.getElementById('team3Name').value=teams.t3.name||'Team 3';
  document.getElementById('team1Name').oninput=()=>{ teams.t1.name=document.getElementById('team1Name').value; saveAll(); renderVCard(); renderLiveLeaderboard(); };
  document.getElementById('team2Name').oninput=()=>{ teams.t2.name=document.getElementById('team2Name').value; saveAll(); renderVCard(); renderLiveLeaderboard(); };
  document.getElementById('team3Name').oninput=()=>{ teams.t3.name=document.getElementById('team3Name').value; saveAll(); renderVCard(); renderLiveLeaderboard(); };
  const list=document.getElementById('teamAssignList'); list.innerHTML='';
  players.forEach(p=>{
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.width='100%';
    const label=document.createElement('div'); label.textContent=p.name; label.style.flex='1';
    const sel=document.createElement('select');
    [['none','No team'],['t1',teams.t1.name||'Team 1'],['t2',teams.t2.name||'Team 2'],['t3',teams.t3.name||'Team 3']].forEach(([v,txt])=> sel.appendChild(new Option(txt,v)));
    if(teams.t1.members.includes(p.id)) sel.value='t1'; else if(teams.t2.members.includes(p.id)) sel.value='t2'; else if(teams.t3.members.includes(p.id)) sel.value='t3'; else sel.value='none';
    sel.onchange=()=>{ ['t1','t2','t3'].forEach(tid=> teams[tid].members=teams[tid].members.filter(id=>id!==p.id)); if(sel.value!=='none') teams[sel.value].members.push(p.id); saveAll(); saveDraft(); renderVCard(); renderLiveLeaderboard(); };
    row.append(label,sel); list.appendChild(row);
  });
}

// ---- rounds & leaderboard ----
document.getElementById('btnSave').onclick=()=>{
  const r={id:uid(), date:new Date().toISOString(), playerIds:[...selectedPlayerIds], scores:{}, scoresTeam:{}};
  selectedPlayerIds.forEach(pid=> r.scores[pid]=(scores[pid]||Array(9).fill(0)).slice());
  ['t1','t2','t3'].forEach(tid=>{ const arr=(teamScores[tid]||Array(9).fill(0)).slice(); if(arr.some(x=>x>0)) r.scoresTeam[tid]=arr; });
  rounds.unshift(r); saveAll(); localStorage.removeItem(LS.draft); alert('Round saved!');
};
document.getElementById('btnCSV').onclick=()=> alert('CSV export coming soon.');
document.getElementById('btnClearRound').onclick=()=>{
  if(!confirm('Start a NEW round and CLEAR all scores?')) return;
  if(!confirm('Are you sure? This cannot be undone.')) return;
  scores={}; selectedPlayerIds.forEach(pid=> scores[pid]=Array(9).fill(0));
  teamScores={t1:Array(9).fill(0),t2:Array(9).fill(0),t3:Array(9).fill(0)};
  saveDraft(); renderVCard(); renderLiveLeaderboard();
};

function renderRounds(){
  const box=document.getElementById('roundsList'); if(!box) return;
  box.innerHTML='';
  if(rounds.length===0){ box.innerHTML='<div class="muted">No rounds saved yet.</div>'; return; }
  rounds.forEach(r=>{
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
    const left=document.createElement('div'); const dt=new Date(r.date); left.textContent=`${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`; left.style.flex='1';
    const del=document.createElement('button'); del.className='warn'; del.textContent='Delete'; del.onclick=()=>{ rounds=rounds.filter(x=>x.id!==r.id); saveAll(); renderRounds(); };
    row.append(left,del); box.appendChild(row);
  });
}

// ---- cut-short helpers ----
function holesPlayedArray(arr){ if(!Array.isArray(arr)) return 0; return arr.reduce((c,v)=> c + ((v&&v>0)?1:0), 0); }
function currentPlayedHolesIndividual(){
  let maxh = 0; (selectedPlayerIds||[]).forEach(pid => { const a=scores[pid]||[]; const h=holesPlayedArray(a); if(h>maxh) maxh=h; });
  return maxh;
}
function currentPlayedHolesTeams(){
  let maxh = 0; ['t1','t2','t3'].forEach(tid=>{ const m=(teams[tid]&&teams[tid].members)||[]; if(m.length>0){ const a=teamScores[tid]||[]; const h=holesPlayedArray(a); if(h>maxh) maxh=h; } });
  return maxh;
}
function playerIsDNF(pid){ const played=holesPlayedArray(scores[pid]||[]); return played < currentPlayedHolesIndividual(); }
function teamIsDNF(tid){ const played=holesPlayedArray(teamScores[tid]||[]); return played < currentPlayedHolesTeams(); }

function computeRanking(){
  if(mode==='individual'){
    const gp = Math.max(1, currentPlayedHolesIndividual());
    return selectedPlayerIds.map(pid=>{
      const name=(players.find(p=>p.id===pid)||{name:pid}).name;
      const arr=(scores[pid]||Array(9).fill(0)).slice(0, gp);
      const dnf = playerIsDNF(pid);
      const total = dnf ? 0 : arr.reduce((a,b)=>a+(b||0),0);
      return {key:pid,name,total,dnf};
    }).sort((a,b)=>(a.dnf-b.dnf)||a.total-b.total||a.name.localeCompare(b.name));
  } else {
    const gp = Math.max(1, currentPlayedHolesTeams());
    return ['t1','t2','t3'].filter(tid=>teams[tid].members.length>0).map(tid=>{
      const arr=(teamScores[tid]||Array(9).fill(0)).slice(0, gp);
      const dnf = teamIsDNF(tid);
      const total = dnf ? 0 : arr.reduce((a,b)=>a+(b||0),0);
      return {key:tid,name:teams[tid].name||tid.toUpperCase(),total,dnf};
    }).sort((a,b)=>(a.dnf-b.dnf)||a.total-b.total||a.name.localeCompare(b.name));
  }
}
function computeWinners(){
  const rows = computeRanking().filter(r=>!r.dnf);
  if(rows.length===0) return [];
  const min = Math.min(...rows.map(r=>r.total));
  return rows.filter(r=>r.total===min);
}
function anyIncomplete(){
  if(mode==='individual'){ return currentPlayedHolesIndividual() < 9; }
  return currentPlayedHolesTeams() < 9;
}

// ---- congrats + tie modal (auto-close) ----
function renderCongratsModal(winners, ranking){
  const modal=document.createElement('div'); modal.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2100";
  const card=document.createElement('div'); card.style.cssText="background:#fff;max-width:640px;width:94%;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden";
  const head=document.createElement('div'); head.style.cssText="padding:16px 18px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center";
  head.innerHTML='<div style="font-weight:700">Results</div>';
  const body=document.createElement('div'); body.style.cssText="padding:18px";
  const t=document.createElement('div'); t.style.cssText="font-size:1.4rem;margin-bottom:8px;font-weight:700"; t.textContent="Congratulations!";
  const n=document.createElement('div'); n.style.cssText="font-size:2rem;font-weight:800;margin-bottom:12px"; n.textContent = winners.map(w=>w.name).join(' & ');
  const sub=document.createElement('div'); sub.style.margin="8px 0 12px 0"; sub.textContent="Final ranking:";
  const list=document.createElement('div'); list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='6px';
  ranking.forEach((r,i)=>{ const row=document.createElement('div'); row.style.cssText="display:flex;justify-content:space-between;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px"; row.innerHTML=`<div>${i+1}. ${r.name}${r.dnf?' · DNF':''}</div><div style="font-weight:700">${r.dnf?'-':r.total}</div>`; list.appendChild(row); });
  const ok=document.createElement('button'); ok.textContent='OK'; ok.onclick=()=>document.body.removeChild(modal);
  body.append(t,n,sub,list,ok); card.append(head,body); modal.append(card); document.body.appendChild(modal);
}

let playoffState = null; // {entries:[{key,name}], holes, scores, mode}
function showFinalModal(contentEl){
  const body = document.getElementById('finalBody');
  body.innerHTML='';
  body.appendChild(contentEl);
  document.getElementById('finalModal').style.display='flex';
}
document.getElementById('finalClose').onclick = ()=>{ document.getElementById('finalModal').style.display='none'; playoffState=null; };

function renderTieModal(tiedRows){
  const wrap=document.createElement('div');
  const title=document.createElement('div'); title.style.fontSize='1.2rem'; title.style.fontWeight='700'; title.textContent='Tie detected';
  const desc=document.createElement('div'); desc.style.margin='6px 0 10px 0'; desc.textContent='Choose a tiebreak: playoff (1–3 holes), keep tied, or pick a winner.';

  const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.alignItems='center';
  const sel=document.createElement('select'); [1,2,3].forEach(n=> sel.appendChild(new Option(`${n} hole${n>1?'s':''}`, n)));
  const start=document.createElement('button'); start.textContent='Start playoff';
  start.onclick=()=>{
    playoffState = { entries: tiedRows.map(r=>({key:r.key,name:r.name})), holes: parseInt(sel.value,10), scores:{}, mode: mode };
    tiedRows.forEach(r => playoffState.scores[r.key] = Array(parseInt(sel.value,10)).fill(0));
    renderPlayoffEntry();
  };
  row.append(sel,start);

  const keep=document.createElement('button'); keep.className='ghost'; keep.textContent='Keep tied';
  keep.onclick=()=>{
    const ranking = computeRanking();
    document.getElementById('finalModal').style.display='none';
    renderCongratsModal(tiedRows, ranking);
  };

  const assignWrap=document.createElement('div'); assignWrap.style.marginTop='10px';
  const label=document.createElement('div'); label.textContent='Or pick a winner:';
  const pick=document.createElement('select'); tiedRows.forEach(r => pick.appendChild(new Option(r.name, r.key)));
  const give=document.createElement('button'); give.textContent='Give win';
  give.onclick=()=>{
    const chosenKey = pick.value;
    let ranking = computeRanking();
    const ix = ranking.findIndex(r=>r.key===chosenKey);
    if(ix>0){ const [w] = ranking.splice(ix,1); ranking.unshift(w); }
    document.getElementById('finalModal').style.display='none';
    renderCongratsModal([ranking[0]], ranking);
  };
  assignWrap.append(label,pick,give);

  wrap.append(title,desc,row,keep,assignWrap);
  showFinalModal(wrap);
}

function renderPlayoffEntry(){
  const wrap=document.createElement('div');
  const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent=`Playoff — ${playoffState.holes} hole${playoffState.holes>1?'s':''}`;
  const grid=document.createElement('table'); grid.style.width='100%';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  trh.appendChild(document.createElement('th')).textContent='Hole';
  playoffState.entries.forEach(e=>{ const th=document.createElement('th'); th.textContent=e.name; trh.appendChild(th); });
  thead.appendChild(trh); grid.appendChild(thead);
  const tbody=document.createElement('tbody');
  for(let i=0;i<playoffState.holes;i++){
    const tr=document.createElement('tr');
    tr.appendChild(document.createElement('th')).textContent = `P${i+1}`;
    playoffState.entries.forEach(e=>{
      const td=document.createElement('td');
      const btn=document.createElement('button'); btn.className='cellbtn'; btn.textContent=String(playoffState.scores[e.key][i]||0);
      btn.onclick=()=>{ keypadTarget = {type:'playoff', key:e.key, idx:i}; directInput.value = playoffState.scores[e.key][i]||0; manualRow.style.display='none'; overlay.style.display='flex'; };
      td.appendChild(btn); tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  grid.appendChild(tbody);
  const finish=document.createElement('button'); finish.textContent='Finish playoff'; finish.style.marginTop='10px';
  finish.onclick=()=>{
    const rows = playoffState.entries.map(e => {
      const total = (playoffState.scores[e.key]||[]).reduce((a,b)=>a+(b||0),0);
      return {key:e.key, name:e.name, total};
    });
    const min = Math.min(...rows.map(r=>r.total));
    const winners = rows.filter(r=>r.total===min);
    if(winners.length===1){
      let ranking = computeRanking();
      const idx = ranking.findIndex(r => r.key===winners[0].key);
      if(idx>0){ const [w] = ranking.splice(idx,1); ranking.unshift(w); }
      document.getElementById('finalModal').style.display='none';
      renderCongratsModal([winners[0]], ranking);
    } else {
      renderTieModal(winners);
    }
  };
  wrap.append(title,grid,finish);
  showFinalModal(wrap);
}

// extend setScore to support playoff keypad updates
const __setScoreOrig = setScore;
setScore = function(targetType, key, idx, v){
  if(targetType==='playoff'){
    if(!playoffState || !playoffState.scores[key]) return;
    playoffState.scores[key][idx] = v;
    renderPlayoffEntry();
    return;
  }
  __setScoreOrig(targetType, key, idx, v);
};

// ---- finalize ----
function finalizeRound(){
  if(anyIncomplete()){ if(!confirm('Round looks cut short. Proceed to finalize based on the holes everyone completed? Players/teams with fewer holes than the rest will be DNF.')) return; }
  const winners=computeWinners(); if(winners.length===0){ alert('No eligible scores to finalize.'); return; }
  winnerKeys=winners.map(w=>w.key); renderVCard();
  const ranking=computeRanking();
  if(winners.length===1){ renderCongratsModal(winners, ranking); } else { renderTieModal(winners); }
  // Auto-save
  const r={id:uid(), date:new Date().toISOString(), playerIds:[...selectedPlayerIds], scores:{}, scoresTeam:{}};
  selectedPlayerIds.forEach(pid=> r.scores[pid]=(scores[pid]||Array(9).fill(0)).slice());
  ['t1','t2','t3'].forEach(tid=>{ const arr=(teamScores[tid]||Array(9).fill(0)).slice(); if(arr.some(x=>x>0)) r.scoresTeam[tid]=arr; });
  rounds.unshift(r); saveAll(); localStorage.removeItem(LS.draft);
}
document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='btnFinalize'){ try{ finalizeRound(); }catch(err){} } });

// ---- mode select binding
const scoreMode=el('scoreMode'); scoreMode.value=mode;
scoreMode.onchange=()=>{ mode=scoreMode.value; save(LS.mode,mode); saveDraft(); renderVCard(); renderLiveLeaderboard(); };

// ---- init
function renderPlayersChips(){ const pc=document.getElementById('playersChips'); pc.innerHTML=''; players.forEach(p=>{ const lbl=document.createElement('label'); lbl.className='tab chip'; const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=selectedPlayerIds.includes(p.id); chk.onchange=()=>{ if(chk.checked){ if(!selectedPlayerIds.includes(p.id)) selectedPlayerIds.push(p.id); if(!scores[p.id]) scores[p.id]=Array(9).fill(0);} else { selectedPlayerIds=selectedPlayerIds.filter(id=>id!==p.id);} renderVCard(); renderLiveLeaderboard(); saveAll(); saveDraft(); }; const span=document.createElement('span'); span.textContent=p.name; lbl.append(chk,span); pc.appendChild(lbl); }); }
function renderLiveLeaderboard(){ const live=document.getElementById('liveLeaders'); if(!live) return; const rows=computeRanking(); live.innerHTML=''; rows.forEach((r,i)=>{ const div=document.createElement('div'); div.className='row'; div.style.justifyContent='space-between'; div.style.border='1px solid #e5e7eb'; div.style.borderRadius='10px'; div.style.padding='8px 10px'; div.innerHTML=`<div>${i+1}. ${r.name}${r.dnf?' · DNF':''}</div><div style="font-weight:700">${r.dnf?'-':r.total}</div>`; live.appendChild(div); }); }
function renderRounds(){ const box=document.getElementById('roundsList'); if(!box) return; box.innerHTML=''; if(rounds.length===0){ box.innerHTML='<div class="muted">No rounds saved yet.</div>'; return; } rounds.forEach(r=>{ const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; const left=document.createElement('div'); const dt=new Date(r.date); left.textContent=`${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`; left.style.flex='1'; const del=document.createElement('button'); del.className='warn'; del.textContent='Delete'; del.onclick=()=>{ rounds=rounds.filter(x=>x.id!==r.id); saveAll(); renderRounds(); }; row.append(left,del); box.appendChild(row); }); }

function init(){
  renderPlayersChips();
  renderSetupPlayers();
  renderTeamsTab();
  renderVCard();
  renderLiveLeaderboard();
  renderRounds();
  saveAll(); saveDraft();
  document.addEventListener('visibilitychange', ()=>{ try{ saveDraft(); }catch(e){} });
  window.addEventListener('pagehide', ()=>{ try{ saveDraft(); }catch(e){} });
  window.addEventListener('beforeunload', ()=>{ try{ saveDraft(); }catch(e){} });
  setInterval(()=>{ try{ saveDraft(); }catch(e){} }, 3000);
}
init();

// ---- PWA registration & update ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./service-worker.js');
      // Manual update trigger
      const btnUp = document.getElementById('btnUpdate');
      if (btnUp) {
        btnUp.onclick = async () => {
          const reg2 = await navigator.serviceWorker.getRegistration();
          await reg2?.update();
          if (reg2?.waiting) {
            reg2.waiting.postMessage('SKIP_WAITING');
          } else {
            alert('No update found.');
          }
        };
      }
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // reload to activate new SW
        window.location.reload();
      });
    } catch (e) {
      console.warn('SW register failed', e);
    }
  });
}

</script>
</body>
</html>
